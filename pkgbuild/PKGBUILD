# Maintainer: Markus Felten <markus.felten@gmx.de>
pkgname=kronos-cluster-node
pkgrel=1
pkgver=r769.4b835cd
epoch=
pkgdesc="kronos cluster node"
arch=('any')
url="http://kronosjs.com/"
license=('BSD')
groups=()
depends=('nodejs')
makedepends=('git')
#checkdepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=()
install=
changelog=
#source=(${pkgname}::https://github.com/Kronos-Integration/kronos-cluster-node.git#tag=v${pkgver})
source=(${pkgname}::git+https://github.com/Kronos-Integration/kronos-cluster-node.git)
noextract=()
md5sums=('SKIP')
validpgpkeys=()

pkgver() {
  cd "$pkgname"
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

build() {
  cd "${pkgname}"
  npm install --production
  find node_modules -name test -type d -print0|xargs -r -0 rm -rf
  find node_modules -name tests -type d -print0|xargs -r -0 rm -rf
  find node_modules -name doc -type d -print0|xargs -r -0 rm -rf
  find node_modules -name docs -type d -print0|xargs -r -0 rm -rf
  find node_modules -name dist -type d -print0|xargs -r -0 rm -rf
  find node_modules -name example -type d -print0|xargs -r -0 rm -rf
  find node_modules -name examples -type d -print0|xargs -r -0 rm -rf
  find node_modules -name "*.patch" -print0|xargs -r -0 rm
  find node_modules -name "README*" -print0|xargs -r -0 rm
  find node_modules -name "Readme*" -print0|xargs -r -0 rm
  find node_modules -name "readme*" -print0|xargs -r -0 rm
  find node_modules -name "HISTORY*" -print0|xargs -r -0 rm
  find node_modules -name "History*" -print0|xargs -r -0 rm
  find node_modules -name "CHANGELOG*" -print0|xargs -r -0 rm
  find node_modules -name "*.1" -print0|xargs -r -0 rm
  find node_modules -name "CONTRIBUTING*" -print0|xargs -r -0 rm
  find node_modules -name "Contributors*" -print0|xargs -r -0 rm
  find node_modules -name "CHANGES*" -print0|xargs -r -0 rm
  find node_modules -name "Changelog*" -print0|xargs -r -0 rm
  find node_modules -name "Makefile*" -print0|xargs -r -0 rm
  find . -name ".gitignore" -print0|xargs -r -0 rm
  find . -name ".npmignore" -print0|xargs -r -0 rm
  find . -name ".travis.yml" -print0|xargs -r -0 rm
  find . -name "*~" -print0|xargs -r -0 rm
  find . -name ".jshintrc" -print0|xargs -r -0 rm
  find . -name ".nvmrc" -print0|xargs -r -0 rm
}

package() {
  cd "${pkgname}"
  install -g kronos -o kronos -d $pkgdir/var/kronos
  install -g kronos -o kronos -d $pkgdir/srv/kronos
  tar cf - samples bin node_modules package.json config.json etc|(cd $pkgdir/srv/kronos;tar xf - )
  (cd pkgbuild/support
   mkdir -p etc/systemd/system/multi-user.target.wants
   ln -s usr/lib/systemd/kronos-cluster-node.service etc/systemd/system/multi-user.target.wants/kronos-cluster-node.service
   tar cf - .)|(cd $pkgdir;tar xf - )
}
