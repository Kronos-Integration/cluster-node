# Maintainer: Markus Felten <markus.felten@gmx.de>
pkgname=kronos-cluster-node
pkgrel=1
pkgver=r1217.1272778
epoch=
pkgdesc="kronos cluster node"
arch=('any')
url="http://kronosjs.com/"
license=('BSD')
groups=()
depends=('nodejs')
makedepends=('git')
#checkdepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=()
install=
changelog=
#source=(${pkgname}::https://github.com/Kronos-Integration/kronos-cluster-node.git#tag=v${pkgver})
source=(${pkgname}::git+https://github.com/Kronos-Integration/kronos-cluster-node.git)
noextract=()
md5sums=('SKIP')
validpgpkeys=()

pkgver() {
  cd "$pkgname"
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

build() {
  cd "${pkgname}"
  npm install --production
  curl -k https://mfelten.de/kronos/kronos-service-manager-ui.tar|tar xvfz -
  find . -name "*~" -print0|xargs -r -0 rm
  find node_modules -name "*.1" -print0|xargs -r -0 rm
  find node_modules -name "*.patch" -print0|xargs -r -0 rm
  find node_modules -iname test -type d -print0|xargs -r -0 rm -rf
  find node_modules -iname tests -type d -print0|xargs -r -0 rm -rf
  find node_modules -iname doc -type d -print0|xargs -r -0 rm -rf
  find node_modules -iname docs -type d -print0|xargs -r -0 rm -rf
  find node_modules -iname dist -type d -print0|xargs -r -0 rm -rf
  find node_modules -iname example -type d -print0|xargs -r -0 rm -rf
  find node_modules -iname examples -type d -print0|xargs -r -0 rm -rf
  find node_modules -iname "readme*" -print0|xargs -r -0 rm
  find node_modules -iname "AUTHORS*" -print0|xargs -r -0 rm
  find node_modules -iname "NOTICE*" -print0|xargs -r -0 rm
  find node_modules -iname "HISTORY*" -print0|xargs -r -0 rm
  find node_modules -iname "SUMMARY.md" -print0|xargs -r -0 rm
  find node_modules -iname "PULL_REQUEST_TEMPLATE.md" -print0|xargs -r -0 rm
  find node_modules -iname "CONTRIBUTING*" -print0|xargs -r -0 rm
  find node_modules -iname "Contributors*" -print0|xargs -r -0 rm
  find node_modules -iname "CHANGES*" -print0|xargs -r -0 rm
  find node_modules -iname "CHANGELOG*" -print0|xargs -r -0 rm
  find node_modules -iname "Makefile*" -print0|xargs -r -0 rm
  find . -name "jsdoc.json" -print0|xargs -r -0 rm
  find . -name "SECURITY.md" -print0|xargs -r -0 rm
  find . -name "SFTPStream.md" -print0|xargs -r -0 rm
  find . -name "LIMITS.md" -print0|xargs -r -0 rm
  find . -name ".gitignore" -print0|xargs -r -0 rm
  find . -name ".gitmodules" -print0|xargs -r -0 rm
  find . -name ".verb.md" -print0|xargs -r -0 rm
  find . -name ".npmignore" -print0|xargs -r -0 rm
  find . -name ".travis.yml" -print0|xargs -r -0 rm
  find . -name ".jshintrc" -print0|xargs -r -0 rm
  find . -name ".eslintrc" -print0|xargs -r -0 rm
  find . -name ".eslintignore" -print0|xargs -r -0 rm
  find . -name ".nvmrc" -print0|xargs -r -0 rm
  find . -name ".zuul.yml" -print0|xargs -r -0 rm
  find . -name ".doclets.yml" -print0|xargs -r -0 rm
  find . -name ".editorconfig" -print0|xargs -r -0 rm
  find . -name ".gitattributes" -print0|xargs -r -0 rm
  find . -name ".tern-project" -print0|xargs -r -0 rm
  find . -name ".dockerignore" -print0|xargs -r -0 rm
  find . -name ".dir-locals.el" -print0|xargs -r -0 rm
}

package() {
  cd "${pkgname}"
  install -g kronos -o kronos -d $pkgdir/var/kronos
  install -g kronos -o kronos -d $pkgdir/srv/kronos
  tar cf - docroot samples bin node_modules package.json config.json etc|(cd $pkgdir/srv/kronos;tar xf - )
  (cd deploy/pkgbuild/support
   mkdir -p etc/systemd/system/multi-user.target.wants
   for i in {1..4}
   do
     ln -s /usr/lib/systemd/system/kronos-cluster-node@.service etc/systemd/system/multi-user.target.wants/kronos-cluster-node@i${i}.service
   done
   tar cf - .)|(cd $pkgdir;tar xf - )
}
