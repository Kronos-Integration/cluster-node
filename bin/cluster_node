#!/usr/bin/env node

/* jslint node: true, esnext: true */

"use strict";

const os = require('os'),
  fs = require('fs'),
  path = require('path'),
  pkginfo = require('pkginfo')(module, 'name', 'version'),
  commander = require('commander'),
  ksm = require('kronos-service-manager'),
  systemdSocket = require('systemd-socket'),
  rebirth = require('rebirth'),
  list_files = require('list_files').list_files;

var journald;

// try to use journald if present
try {
  journald = require('journald');
} catch (e) {}

const logger = journald ? journald.Log : console;

let logLevel = "trace";

const kronosOptions = {
  logger: logger,
  logLevel: logLevel,
  services: {
    "consul": {
      "logLevel": logLevel
    },
    "admin": {
      "logLevel": logLevel,
      "port": 10000
    }
  }
};

commander
  .version(module.exports.version)
  .description('run cluster node')
  //  .option('-ar, --autoregister', 'load and register all installed kronos moudles')
  .option('-n, --nodename <name>', 'kronos node name defaults to hostname')
  .option('-f, --flow <file>', 'specify flow definition to be registered')
  .option('-s, --start', 'also start flow after registering')
  .option('-d, --debug', 'enable debugging')
  .option('-d, --dataCenter <dataCenter>', 'specify consul data center')
  .option('-p, --port <portNumber>', `specify kronos http port (default is ${kronosOptions.services.admin.port})`)
  .parse(process.argv);

if (commander.debug) {
  logLevel = 'debug';
}

kronosOptions.name = commander.nodename ? commander.nodename : os.hostname();

if (commander.dataCenter) {
  serviceConfigs.consul.dataCenter = commander.dataCenter;
}

if (commander.port) {
  kronosOptions.services.admin.port = commander.port;
} else {
  kronosOptions.services.admin.port = systemdSocket();
}

process.on('SIGHUP', () => {
  logger.log('reboot');
  rebirth();
});

ksm.manager(kronosOptions).then(manager => {
    try {
      const baseDir = path.join(__dirname, '..', 'node_modules');
      list_files(baseDir, '', 'package.json', function (error, file, stat) {
        const f = path.join(baseDir, file);
        fs.readFile(f, function (err, data) {
          if (err) {
            manager.error(`loading ${f}: ${e}`);
            return;
          }
          try {
            const p = JSON.parse(data);

            if (p.keywords) {
              if (p.keywords.indexOf('kronos-step') >= 0 || p.keywords.indexOf('kronos-service') >= 0) {
                try {
                  require(p.name).registerWithManager(manager);
                  manager.info(level => `${p.name} registered`);
                } catch (e) {
                  manager.error(`${f}: ${p.name} ${e}`);
                }
              }
            }
          } catch (e) {
            manager.error(`${f}: ${e}`);
          }
        });
      }, function () {
        manager.info(level => Object.keys(manager.services).map(name => {
          const s = manager.services[name];
          return `${name}:\n  state: ${s.state}\n  autostart: ${s.autostart}\n  logLevel: ${s.logLevel}`;
        }).join('\n'));

        if (commander.flow) {
          manager.loadFlowFromFile(commander.flow).then(flow => {
            manager.info(level => `Flow declared: ${flow}`);
            if (commander.start) {
              manager.info(level => `Starting ... ${flow}`);
              flow.start().then(() => manager.info(`Flow started: ${flow}`)).catch(error => manager.error(
                `Flow started failed: ${error}`))
            }
          }).catch(error => {
            manager.error(`Flow initialization failed: ${error}`);
          });
        }
      });
    } catch (e) {
      manager.error(e);
    }

    return manager;
  },
  function (err) {
    manager.error(`manager failed: ${err}`);
  });
