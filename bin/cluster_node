#!/usr/bin/env node

/* jslint node: true, esnext: true */

"use strict";

const os = require('os'),
  path = require('path'),
  pkginfo = require('pkginfo')(module, 'name', 'version'),
  commander = require('commander'),
  ksm = require('kronos-service-manager'),
  systemdSocket = require('systemd-socket'),
  rebirth = require('rebirth');

var journald;

// try to use journald if present
try {
  journald = require('journald');
} catch (e) {}

const logger = journald ? journald.Log : console;

const kronosOptions = {
  logger: logger,
  services: {
    "consul": {
      "logLevel": "trace"
    },
    "admin": {
      "logLevel": "trace",
      "port": 10000
    }
  }
};

commander
  .version(module.exports.version)
  .description('run cluster node')
  .option('-n, --nodename <name>', 'kronos node name defaults to hostname')
  .option('-f, --flow <file>', 'specify flow definition to be registered')
  .option('-s, --start', 'also start flow after registering')
  .option('-d, --dataCenter <dataCenter>', 'specify consul data center')
  .option('-p, --port <portNumber>', `specify kronos http port (default is ${kronosOptions.services.admin.port})`)
  .parse(process.argv);

kronosOptions.name = commander.nodename ? commander.nodename : os.hostname();

if (commander.dataCenter) {
  serviceConfigs.consul.dataCenter = commander.dataCenter;
}

if (commander.port) {
  kronosOptions.services.admin.port = commander.port;
} else {
  kronosOptions.services.admin.port = systemdSocket();
}

process.on('SIGHUP', () => {
  logger.log('reboot');
  rebirth();
});


ksm.manager(kronosOptions).then(manager => {
    ['kronos-step-archive-tar', 'kronos-step-stdio', 'kronos-step-system', 'kronos-flow',
      'kronos-adapter-inbound-http', 'kronos-http-routing-step', 'kronos-flow-control-step',
      'kronos-service-manager-consul', 'kronos-service-manager-admin',
    ].forEach(name => {
      require(name).registerWithManager(manager);
    });

    console.log(Object.keys(manager.services).map(name => {
      const s = manager.services[name];
      return `${name}:\n  state: ${s.state}\n  autostart: ${s.autostart}\n  logLevel: ${s.logLevel}`;
    }).join('\n'));

    if (commander.flow) {
      manager.loadFlowFromFile(commander.flow).then(flow => {
        logger.log(`Flow declared: ${flow}`);
        if (commander.start) {
          logger.log(`Starting ... ${flow}`);
          flow.start().then(() => logger.log(`Flow started: ${flow}`)).catch(error => logger.log(
            `Flow started failed: ${error}`))
        }
      }).catch(error => {
        logger.log(`Flow initialization failed: ${error}`);
      });
    }

    logger.log(`manager: ${manager}`);
    return manager;
  },
  function (err) {
    logger.log(`manager failed: ${err}`);
  });
