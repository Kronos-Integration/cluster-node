#!/usr/bin/env iojs

/* jslint node: true, esnext: true */

"use strict";

const fs = require('fs');
const path = require('path');
const commander = require('commander');
const ksm = require('kronos-service-manager');
const ksmr = require('kronos-service-manager-rest');
const csm = require('consul-service-manager');


const consulOptions = {};

const restOptions = {};

commander
  .option('-f, --flow <file>', 'specify flow definition')
  .option('-d, --dataCenter <dataCenter>', 'specify consul data center')
  .option('-p, --port <portNumber>', `specify kronos http port (default is ${ksmr.defaultKronosPort})`)
  .parse(process.argv);

if (commander.dataCenter) {
  consulOptions.dataCenter = commander.dataCenter;
}

if (commander.port) {
  restOptions.port = commander.port;
}

csm.manager(ksmr.manager(ksm.manager(), restOptions), consulOptions).then(function (manager) {
  require('kronos-step-archive-tar').registerWithManager(manager);
  require('kronos-step-file-common').registerWithManager(manager);

  if (commander.flow) {
    try {
      manager.declareFlows(JSON.parse(fs.readFileSync(commander.flow)));
    } catch (err) {
      console.log(`flow failed: ${err}`);
    }
  }

  console.log(`manager: ${manager}`);
}, function (err) {
  console.log(`manager failed: ${err}`);
});
