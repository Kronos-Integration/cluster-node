#!/usr/bin/env node

/* jslint node: true, esnext: true */

"use strict";

const os = require('os'),
  fs = require('fs'),
  path = require('path'),
  pkginfo = require('pkginfo')(module, 'name', 'version'),
  commander = require('commander'),
  ksm = require('kronos-service-manager'),
  ksma = require('kronos-service-manager-admin'),
  systemdSocket = require('systemd-socket'),
  // launchd = require('node-launchd'),
  rebirth = require('rebirth'),
  serve = require('koa-static');

var journald;

// try to use journald if present
try {
  journald = require('journald');
} catch (e) {}

const logger = journald ? journald.Log : console;

const consulOptions = {};
const adminOptions = {};
const kronosOptions = {
  logger: logger
};

commander
  .version(module.exports.version)
  .description('run cluster node')
  .option('-n, --nodename <name>', 'kronos node name defaults to hostname')
  .option('-f, --flow <file>', 'specify flow definition to be registered')
  .option('-s, --start', 'also start flow after registering')
  .option('-d, --dataCenter <dataCenter>', 'specify consul data center')
  .option('-p, --port <portNumber>', `specify kronos http port (default is ${ksma.defaultKronosPort})`)
  .parse(process.argv);

kronosOptions.name = commander.nodename ? commander.nodename : os.hostname();

if (commander.dataCenter) {
  consulOptions.dataCenter = commander.dataCenter;
}

if (commander.port) {
  adminOptions.port = commander.port;
} else {
  /*
  const fd = getSocketFileDescriptorForName('HTTPSocket');
  if (fd) {
    restOptions.port = {
      fd: fd
    };
  }*/
  adminOptions.port = systemdSocket();
}

process.on('SIGHUP', function () {
  logger.log('reboot');
  rebirth();
});

ksma.manager(ksm.manager(kronosOptions), adminOptions).then(function (manager) {

  const docroot = path.join(__dirname, '../docroot');

  logger.log(`serving ${docroot}`);
  manager.app.use(serve(docroot));

  ['kronos-service-manager-consul', 'kronos-step-archive-tar', 'kronos-step-stdio', 'kronos-step-system',
    'kronos-flow'
  ].forEach(name => require(
    name).registerWithManager(manager));

  console.log(`services: ${JSON.stringify(Object.keys(manager.services))}`);

  if (commander.flow) {
    try {
      manager.registerFlow(manager.getStepInstance(JSON.parse(fs.readFileSync(commander.flow)))).then(
        function (flow) {
          logger.log(`Flow declared: ${flow}`);
          if (commander.start) {
            logger.log(`starting ... ${flow}`);

            flow.start().then(() => logger.log(`Flow started: ${flow}`), (rejected) => logger.log(
                `Flow error: ${flow} ${rejected}`))
              .catch((error) => logger.log(
                `Flow started failed: ${error}`));
          }
        },
        function (rejected) {
          logger.log(`Flow initialization failed: ${rejected}`);
        }
      );
    } catch (err) {
      logger.log(`Flow initialization failed: ${err}`);
    }
  }

  logger.log(`manager: ${manager}`);
  return manager;
}, function (err) {
  logger.log(`manager failed: ${err}`);
});
