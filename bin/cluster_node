#!/usr/bin/env node

/* jslint node: true, esnext: true */

"use strict";

const os = require('os');
const fs = require('fs');
const path = require('path');
const commander = require('commander');
const ksm = require('kronos-service-manager');
const ksmr = require('kronos-service-manager-rest');
const csm = require('kronos-consul-service-manager');
const systemdSocket = require('systemd-socket');
//const launchd = require('node-launchd');
const rebirth = require('rebirth');
const serve = require('koa-static');

const consulOptions = {
  logger: console
};

const restOptions = {};
const kronosOptions = {};

commander
  .option('-n, --name <name>', 'kronos node name defaults to hostname')
  .option('-f, --flow <file>', 'specify flow definition to be registered')
  .option('-s, --start', 'also start flow after registering')
  .option('-d, --dataCenter <dataCenter>', 'specify consul data center')
  .option('-p, --port <portNumber>', `specify kronos http port (default is ${ksmr.defaultKronosPort})`)
  .parse(process.argv);

if (commander.name) {
  kronosOptions.name = commander.name;
} else {
  kronosOptions.name = os.hostname();
}

if (commander.dataCenter) {
  consulOptions.dataCenter = commander.dataCenter;
}

if (commander.port) {
  restOptions.port = commander.port;
} else {
  /*
  const fd = getSocketFileDescriptorForName('HTTPSocket');
  if (fd) {
    restOptions.port = {
      fd: fd
    };
  }*/
  restOptions.port = systemdSocket();
}

process.on('SIGHUP', function () {
  console.log('reboot');
  rebirth();
});

csm.manager(ksmr.manager(ksm.manager(kronosOptions), restOptions), consulOptions).then(function (manager) {

  const docroot = path.join(__dirname, '../docroot');

  console.log(`serving ${docroot}`);
  manager.app.use(serve(docroot));

  require('kronos-step-archive-tar').registerWithManager(manager);
  require('kronos-service-manager-addon').registerWithManager(manager);

  if (commander.flow) {
    try {
      manager.registerFlow(JSON.parse(fs.readFileSync(commander.flow))).then(
        function (flow) {
          console.log(`Flow declared: ${flow}`);
          if (commander.start) {
            flow.start();
          }
        },
        function (rejected) {
          console.log(`Flow declaration/initialization failed: ${rejected}`);
        }
      );
    } catch (err) {
      console.log(`Flow declaration/initialization failed: ${err}`);
    }
  }

  console.log(`manager: ${manager}`);
  return manager;
}, function (err) {
  console.log(`manager failed: ${err}`);
});
